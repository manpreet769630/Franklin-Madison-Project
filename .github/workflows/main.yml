name: CI

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Set up Node.js
      uses: actions/setup-node@v2
      with:
        node-version: '14'

    - name: Install dependencies
      run: npm install

    - name: Install Cypress
      run: npm install cypress

    - name: Verify Cypress binary
      run: npx cypress verify

    - name: Run Cypress tests
      run: npm run test:stage

    - name: Upload Test Artifacts
      if: failure()
      uses: actions/upload-artifact@v3
      with:
        name: cypress-test-report
        path: mochawesome-report/mochawesome.html

    - name: Upload Cypress Screenshots
      if: always()
      uses: actions/upload-artifact@v3
      with:
        name: cypress-screenshots
        path: cypress/screenshots

    - name: Send Slack notification on failure
      if: always()
      run: |
        echo '{
          "reports": [
            {
              "targets": [
                {
                  "name": "slack",
                  "inputs": {
                    "url": "'"${{ secrets.SLACK_WEBHOOK_URL }}"'",
                    "title": "Franklin Madison- Sanity Checks",
                    "channel": "#cypress-test"
                  },
                  "extensions": [
                    {
                      "name": "mentions",
                      "inputs": {
                        "users": [
                          {
                            "name": "Manpreet",
                            "slack_uid": "U0664FMNYPL"
                          }
                        ]
                      }
                    },
                    {
                      "name": "quick-chart-test-summary"
                    }
                  ]
                }
              ],
              "results": [
                {
                  "type": "mocha",
                  "files": ["cypress/mochawesome-report/mochawesome.html"]
                }
              ]
            }
          ]
        }' > report-config.json
